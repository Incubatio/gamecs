// Generated by CoffeeScript 1.4.0
(function() {

  define(function(require) {
    var Director, Entity, gamecs;
    gamecs = require('gamecs');
    Entity = require('entity');
    return Director = (function() {

      Director.prototype.loadImage = function(suffix) {
        return gamecs.Img.load(this.data.prefixs.image + suffix);
      };

      Director.prototype.getRandPos = function(x, y) {
        if (x == null) {
          x = false;
        }
        if (y == null) {
          y = false;
        }
        if (x === false) {
          x = Math.round(Math.random() * this.data.screen.size[0]);
        }
        if (y === false) {
          y = Math.round(Math.random() * this.data.screen.size[1]);
        }
        return [x, y];
      };

      Director.prototype.createStar = function(options) {
        var k, pos, star, v;
        if (options == null) {
          options = {};
        }
        k = 'Star';
        v = this.data.sprites[k];
        pos = this.getRandPos(options.x, options.y);
        star = new Entity(pos, v, {
          name: k,
          rect: new gamecs.Rect(pos, v.Visible.size),
          dirty: true
        });
        star.components.Mobile.speed = Math.round(v.Mobile.speed * Math.random()) + 1;
        return star;
      };

      Director.prototype.createMeteor = function(options) {
        var k, pos, star, v;
        if (options == null) {
          options = {};
        }
        k = 'Meteor';
        v = this.data.sprites[k];
        pos = this.getRandPos(options.x, -v.Visible.size[1]);
        star = new Entity(pos, v, {
          name: k,
          rect: new gamecs.Rect(pos, v.Visible.size),
          dirty: true
        });
        star.components.Mobile.speed = Math.round(v.Mobile.speed * Math.random()) + 1;
        return star;
      };

      function Director(display, data) {
        var entity, i, k, pos, v, _i, _j, _len, _ref, _ref1, _ref2, _ref3;
        this.display = display;
        this.data = data;
        this.display.bg1.fill('#000');
        this.display.fg.blit((new gamecs.Font('45px Sans-serif')).render('Hello World'));
        _ref = this.data.sprites;
        for (k in _ref) {
          v = _ref[k];
          if (v.Visible && v.Visible.image) {
            v.Visible.image_urn = v.Visible.image;
            v.Visible.image = this.loadImage(v.Visible.image_urn);
            v.Visible.size = v.Visible.image.getSize();
          }
        }
        this.groups = {
          stars: [],
          sprites: []
        };
        _ref1 = this.data.scene.actors;
        for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
          _ref2 = _ref1[_i], k = _ref2[0], pos = _ref2[1];
          v = this.data.sprites[k];
          entity = new Entity(pos, v, {
            name: k,
            rect: new gamecs.Rect(pos, v.Visible.size),
            dirty: true
          });
          entity.oldRect = entity.rect.clone();
          this.groups.sprites.push(entity);
          if (entity.name === "Player") {
            this.player = entity;
          }
        }
        for (i = _j = 0, _ref3 = this.data.stars.number; 0 <= _ref3 ? _j <= _ref3 : _j >= _ref3; i = 0 <= _ref3 ? ++_j : --_j) {
          this.groups.stars.push(this.createStar());
        }
      }

      Director.prototype.handleInput = function(events) {
        var component, event, x, y, _i, _len, _results;
        component = this.player.components.Mobile;
        _results = [];
        for (_i = 0, _len = events.length; _i < _len; _i++) {
          event = events[_i];
          x = component.moveX;
          y = component.moveY;
          if (event.type === gamecs.Input.T_KEY_DOWN) {
            switch (event.key) {
              case gamecs.Input.K_UP:
              case gamecs.Input.K_w:
                y = -1;
                break;
              case gamecs.Input.K_DOWN:
              case gamecs.Input.K_s:
                y = 1;
                break;
              case gamecs.Input.K_LEFT:
              case gamecs.Input.K_a:
                x = -1;
                break;
              case gamecs.Input.K_RIGHT:
              case gamecs.Input.K_d:
                x = 1;
                break;
              case gamecs.Input.K_SPACE:
                this.player.firing = true;
            }
          } else if (event.type === gamecs.Input.T_KEY_UP) {
            switch (event.key) {
              case gamecs.Input.K_UP:
              case gamecs.Input.K_w:
                if (y < 0) {
                  y = 0;
                }
                break;
              case gamecs.Input.K_DOWN:
              case gamecs.Input.K_s:
                if (y > 0) {
                  y = 0;
                }
                break;
              case gamecs.Input.K_LEFT:
              case gamecs.Input.K_a:
                if (x < 0) {
                  x = 0;
                }
                break;
              case gamecs.Input.K_RIGHT:
              case gamecs.Input.K_d:
                if (x > 0) {
                  x = 0;
                }
                break;
              case gamecs.Input.K_SPACE:
                this.player.firing = false;
            }
          }
          component.moveX = x;
          _results.push(component.moveY = y);
        }
        return _results;
      };

      Director.prototype.update = function() {
        var entity, group, h, i, k, pos, v, w, w2, _i, _len, _ref, _ref1, _results;
        _ref = this.groups;
        for (k in _ref) {
          group = _ref[k];
          for (_i = 0, _len = group.length; _i < _len; _i++) {
            entity = group[_i];
            if (entity.components.Mobile) {
              w = this.data.screen.size[0];
              h = this.data.screen.size[1];
              w2 = Math.round(entity.rect.width / 2);
              if (entity.name === 'Player') {
                if (entity.rect.left < -w2) {
                  entity.rect.left = -w2;
                } else if (entity.rect.right > w + w2) {
                  entity.rect.right = w + w2;
                }
                if (entity.rect.top < 0) {
                  entity.rect.top = 0;
                } else if (entity.rect.bottom > h) {
                  entity.rect.bottom = h;
                }
              } else {
                if (entity.rect.left < -w2 || entity.rect.right > w + w2 || entity.rect.bottom < 0 || entity.rect.top > h) {
                  entity.kill = true;
                  if (entity.name === 'Star' && this.groups.stars.length <= this.data.stars.number) {
                    this.groups.stars.push(this.createStar({
                      y: 0
                    }));
                  }
                }
              }
            }
          }
        }
        if (this.player.cooldown <= 0 || !this.player.cooldown) {
          if (this.player.firing) {
            v = this.data.sprites.RLazer;
            pos = [this.player.rect.left + 45, this.player.rect.top - 50];
            this.groups.sprites.push(new Entity(pos, v, {
              name: k,
              rect: new gamecs.Rect(pos, v.Visible.size),
              dirty: true
            }));
            this.player.cooldown = 100;
          }
        } else {
          this.player.cooldown -= 30;
        }
        if (this.data.meteors.cooldown <= 0 || !this.data.meteors.cooldown) {
          this.groups.sprites.push(this.createMeteor());
          this.data.meteors.cooldown = this.data.meteors.spawnRate;
        } else {
          this.data.meteors.cooldown -= 30;
        }
        _ref1 = this.groups;
        _results = [];
        for (k in _ref1) {
          group = _ref1[k];
          _results.push((function() {
            var _j, _ref2, _results1;
            _results1 = [];
            for (i = _j = 0, _ref2 = group.length; 0 <= _ref2 ? _j < _ref2 : _j > _ref2; i = 0 <= _ref2 ? ++_j : --_j) {
              entity = group[i];
              if (entity && entity.kill) {
                this.display.fg.clear(entity.rect);
                _results1.push(group.splice(i, 1));
              } else {
                _results1.push(void 0);
              }
            }
            return _results1;
          }).call(this));
        }
        return _results;
      };

      return Director;

    })();
  });

}).call(this);
